var $=require("path"),O=require("react"),S=require("node:fs/promises"),b=require("html-minifier"),T=require("react-dom/server"),{minify:q}=b,{renderToString:I}=T,{readFile:H,writeFile:M,cp:w,readdir:k,rm:L}=S,N=process.cwd(),A=t=>typeof t=="string"&&t.length>0,f=t=>A(t)?`${N}${t}`:null,g=(t,e)=>A(t)?`${e}${t}`:null;module.exports=(t={})=>{let e=f(t.outDir);if(!e)throw new Error("Must specify out directory");let r=f(t.cssFrom),s=f(t.htmlFrom),n=f(t.assetsFrom),c=g(t.jsOut,e),o=g(t.cssOut,e),a=g(t.htmlOut,e),l=g(t.assetsOut,e),u=t.redux||{store:null,Provider:null},h=[];return{name:"reactHydrationPlugin",setup:y=>{y.onStart(async()=>{await U(e),h=await W(s,a,l||n),l&&n&&await w(n,l,{recursive:!0}),o&&r&&await w(r,o,{recursive:!0})}),y.onLoad({filter:/\.static.jsx$/},d=>{let m=d.path,i=X(m),F=`id="${i}">`,R=`data-${i}=`;for(let x of h){let{content:C,path:E}=x;if(!C.includes(F))continue;let D={redux:u,attrId:F,content:C,attrData:R,componentPath:m,suffix:d.suffix};x.content=Z(D),console.log("Component:",i),console.log("Injected in:",E),console.log("-------------------------------------------"),console.log("-------------------------------------------")}return{loader:"jsx"}}),y.onEnd(async()=>{let d=await p(c,"js"),m=await p(o||r,"css");for(let i of h)i.content=Y(m,i.path,i.content),i.content=V(d,i.path,i.content),await M(i.path,i.content)})}}};var U=async t=>{try{await L(t,{recursive:!0,force:!0})}catch(e){logError(`removeFile : ${e.message}`)}},W=async(t,e,r)=>{let s=[];try{if(!t||!e)throw new Error("Must specify html entry & out directory");await w(t,e,{recursive:!0});let n=await p(e,"html");s=await J(n,r)}catch(n){console.error("getPages - Can't get html outputs paths:",n.message)}finally{return s}},p=async(t,e)=>{if(!t)return[];let r=await k(t,{withFileTypes:!0}),s=await Promise.all(r.map(n=>{let c=$.resolve(t,n.name);return n.isDirectory()?p(c,e):c}));return Array.prototype.concat(...s).filter(n=>n.includes(`.${e}`))},J=async(t,e)=>{let r=[];try{let s=t.map(async n=>new Promise((c,o)=>{H(n,"utf8").then(a=>{a||o(`readPages - cannot read file at path ${n}`);let l=q(a,{caseSensitive:!0,collapseWhitespace:!0,conservativeCollapse:!0}),u=_(e,n,l);c({path:n,content:u})}).catch(a=>o(a))}));r=await Promise.all(s)}catch(s){console.error("readPages - cannot read files",s.message)}finally{return r}},V=(t,e,r)=>{let s="<!-- {scripts} -->",c=t.map(o=>P(o,e)).map(K).reduce((o,a)=>`${o}${a}`,"");return v(r,s,c)},Y=(t,e,r)=>{let s="<!-- {styles} -->",c=t.map(o=>P(o,e)).map(G).reduce((o,a)=>`${o}${a}`,"");return v(r,s,c)},_=(t,e,r)=>{let s="{assets}",n=t?P(t,e):".";return B(r,n,s)},B=(t,e,r)=>{let s=t;for(;s.includes(r);)s=v(s,r,e);return s},v=(t,e,r)=>{let s=t.indexOf(e);if(s<0)return t;let n=s+e.length,c=t.substring(0,s),o=t.substring(n);return`${c}${r}${o}`},G=t=>`<link rel="stylesheet" href="${t}">`,K=t=>`<script defer async src="${t}"></script>`,P=(t,e)=>{let r=j(e,t),s=Q(r.length),n=j(t,e);return[s,...n].join("/")},j=(t,e)=>{let r=t.split("/"),s=e.split("/");return r.reduce((n,c,o)=>s[o]===c?[...n]:[...n,c],[])},Q=t=>{let e=t-1;if(e===0)return".";let r="";for(let s=0;s<e;s++)r+="../";return r.slice(0,-1)},X=t=>{let e=$.basename(t,$.extname(t)),r=e.substring(0,e.indexOf(".static"));return`${r.slice(0,1).toLowerCase()}${r.slice(1)}`},Z=t=>{let{content:e,attrData:r,attrId:s,componentPath:n,suffix:c,redux:o}=t,a=e.indexOf(s);if(a<0)return e;let l=z(e,a,r),u=tt(n,l,c,o);return et(u,e,a,s.length)},z=(t,e,r)=>{if(!t.includes(r))return{};let s=t.indexOf(r)+r.length+1,n=e-2,c=t.substring(s,n);try{let o=JSON.parse(c);return console.log(`${r}`,o),o}catch(o){return console.error(`getComponentData - cannot parse ${c} from html:`,o.message),{}}},tt=(t,e,r,s)=>{let n=require(t);n.default&&(n=n.default);let c=O.createElement(n,{data:e});try{if(!r.includes("provider"))return I(c);if(!s.store||!s.Provider)throw new Error(`You must provide a store and Provider for ${t}`);let{store:o,Provider:a}=s;return I(O.createElement(a,{store:o},c))}catch(o){return console.error("getComponenHtml - cannot renderToString:",o.message),""}},et=(t,e,r,s)=>{let n=e.substring(0,r+s),c=e.substring(r+s);return`${n}${t}${c}`};
