var R=require("path"),W=require("react"),j=require("node:fs/promises"),x=require("html-minifier"),O=require("react-dom/server"),{minify:A}=x,{renderToString:_}=O,{readFile:C,writeFile:D,cp:m,readdir:S,rm:q}=j,E=process.cwd(),P=t=>typeof t=="string"&&t.length>0,u=t=>P(t)?`${E}${t}`:null,h=(t,e)=>P(t)?`${e}${t}`:null;module.exports=(t={})=>{let e=u(t.outDir);if(!e)throw new Error("Must specify out directory");let s=u(t.cssFrom),r=u(t.htmlFrom),n=u(t.assetsFrom),c=h(t.jsOut,e),a=h(t.cssOut,e),i=h(t.htmlOut,e),l=h(t.assetsOut,e),y=t.redux||{store:null,Provider:null},w=[];return{name:"reactHydrationPlugin",setup:f=>{f.onStart(async()=>{await T(e),w=await I(r,i),l&&n&&await m(n,l,{recursive:!0}),a&&s&&await m(s,a,{recursive:!0})}),f.onLoad({filter:/\.static.jsx$/},v=>(console.log("react hydration onLoad (.static.jsx)"),{loader:"jsx"})),f.onEnd(async()=>{let v=await g(c,"js"),F=await g(a||s,"css");for(let o of w)o.content=b(F,o.path,o.content),o.content=L(v,o.path,o.content),o.content=k(l||n,o.path,o.content),await D(o.path,o.content)})}}};var T=async t=>{try{await q(t,{recursive:!0,force:!0})}catch(e){logError(`removeFile : ${e.message}`)}},I=async(t,e)=>{let s=[];try{if(!t||!e)throw new Error("Must specify html entry & out directory");await m(t,e,{recursive:!0});let r=await g(e,"html");s=await M(r)}catch(r){console.error("getPages - Can't get html outputs paths:",r.message)}finally{return s}},g=async(t,e)=>{if(!t)return[];let s=await S(t,{withFileTypes:!0}),r=await Promise.all(s.map(n=>{let c=R.resolve(t,n.name);return n.isDirectory()?g(c,e):c}));return Array.prototype.concat(...r).filter(n=>n.includes(`.${e}`))},M=async t=>{let e=[];try{let s=t.map(async r=>new Promise((n,c)=>{C(r,"utf8").then(a=>{a||c(`Can't read file ${r}`);let i=A(a,{caseSensitive:!0,collapseWhitespace:!0,conservativeCollapse:!0});n({path:r,content:i})}).catch(a=>c(a))}));e=await Promise.all(s)}catch(s){console.error("Can't read files",s.message)}finally{return e}},k=(t,e,s)=>{let r="{assets}",n=t?d(t,e):".";return p(s,[n],r)},L=(t,e,s)=>{let r="<!-- {scripts} -->",n=t.map(c=>d(c,e)).map(H);return p(s,n,r)},b=(t,e,s)=>{let r="<!-- {styles} -->",n=t.map(c=>d(c,e)).map(N);return p(s,n,r)},p=(t,e,s)=>{let r=t.indexOf(s);if(r<0)return t;let n=r+s.length,c=t.substring(0,r),a=t.substring(n),i=e.reduce((l,y)=>`${l}${y}`,"");return`${c}${i}${a}`},H=t=>`<script defer async src="${t}"></script>`,N=t=>`<link rel="stylesheet" href="${t}">`,d=(t,e)=>{let s=$(e,t),r=U(s.length),n=$(t,e);return[r,...n].join("/")},$=(t,e)=>{let s=t.split("/"),r=e.split("/");return s.reduce((n,c,a)=>r[a]===c?[...n]:[...n,c],[])},U=t=>{let e=t-1;if(e===0)return".";let s="";for(let r=0;r<e;r++)s+="../";return s.slice(0,-1)};
